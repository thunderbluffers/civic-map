{% extends "base.html" %}
{% load i18n %}
{% load map_tags %}

{% block content %}

<div class="container-fluid">
    <div class="row-fluid">
        <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">
            {% for location in locations %}
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <a href="{{ location.get_absolute_url }}">{{ location.name }}</a>
                    </div>
                    <div class="panel-body">
                        <p>{{ location.description }}</p>
                    </div>
                </div>
            {% endfor %}

            <div class="pagination">
                <span class="step-links">
                    {% if locations.has_previous %}
                        <a href="?page={{ locations.previous_page_number }}">previous</a>
                    {% endif %}

                    <span class="current">
                        Page {{ locations.number }} of {{ locations.paginator.num_pages }}.
                    </span>

                    {% if locations.has_next %}
                        <a href="?page={{ locations.next_page_number }}">next</a>
                    {% endif %}
                </span>
            </div>
        </div>
        <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
            <div>
                {% map initLocation.latitude initLocation.longitude %}
            </div>

            <div id="locationInfo" class="panel panel-default panel-collapse collapse" style="overflow: hidden">
                <div class="panel-heading">
                    <h2 id="hName"></h2>
                </div>
                <div class="panel-body">
                    <ul>
                        <li>
                            <b>Description: </b>
                            <p id="pDescription"></p>
                        </li>
                        <li>
                            <b>Program: </b>
                            <p id="pProgram"></p>
                        </li>
                        <li>
                            <b>Contact: </b>
                            <p id="pContact"></p>
                        </li>
                    </ul>
                    <a id="aReviews" href="">View reviews</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block extrajs %}

<script>
    var locations = [];
    {% for location in locations %}
        locations.push({ // TODO: this can surely be done better
            lat: {{ location.latitude }},
            lng: {{ location.longitude }},
            name: '{{ location.name }}',
            description: '{{ location.description }}',
            program: '{{ location.program }}',
            contact: '{{ location.contact_info }}',
            url: '{{location.get_absolute_url}}'
        });
    {% endfor %}

    var loadInfoWithLocation = function(location) {
        var hName = document.getElementById('hName');
        var pDescription = document.getElementById('pDescription');
        var pProgram = document.getElementById('pProgram');
        var pContact = document.getElementById('pContact');
        var aReviews = document.getElementById('aReviews');

        hName.innerHTML = location.name;
        pDescription.innerHTML = location.description;
        pProgram.innerHTML = location.program;
        pContact.innerHTML = location.contact;
        aReviews.href = location.url;
    }

    var toggleInfoVisible = function(b) {
        var locationInfo = document.getElementById('locationInfo');
        if (b === true) {
            //locationInfo.style.maxHeight = '300px';
            $('#locationInfo').collapse('show');
        }
        else {
            var aReviews = document.getElementById('aReviews');
            aReviews.href = '';
            //locationInfo.style.maxHeight = '0px';
            $('#locationInfo').collapse('hide');
        }
    }

    // Adds a marker to the map.
    var addMarker = function(location, map) {
        // Add the marker at the clicked location, and add the next-available label
        // from the array of alphabetical characters.
        var marker = new google.maps.Marker({
            position: {
                lat: location.lat,
                lng: location.lng
            },
            map: map
        });

        marker.addListener('click', function() {
            loadInfoWithLocation(location);
            toggleInfoVisible(true);
        });

        window.markers.push(marker);
    }

    google.maps.event.addDomListener(window, 'load', function() {
        for (var i in locations) {
            var location = locations[i];

            addMarker(location, window.map);
        }

        window.mapElem.style.width = '100%';
        window.mapElem.style.paddingBottom = '62%';
        google.maps.event.trigger(map, 'resize');

        window.map.setZoom(16);

        window.map.addListener('click', function() {
            toggleInfoVisible(false);
        });
    });


</script>

{% endblock %}
